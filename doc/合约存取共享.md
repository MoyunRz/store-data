# 合约存、取、共享

## 整体流程

- 用户通过上传加密内容、文件名、文件类型等信息向智能合约发起请求。
- 智能合约在接收到请求后，对加密内容进行md5加密，并将文件名、文件类型、加密内容和md5值存储到map中。
- 智能合约将存储结果返回给用户。
- 在用户需要查询文件时，他可以提供文件名和时间范围等信息，然后智能合约搜索map中的信息并返回未解密到内容、文件名、文件类型和md5值。

- **流程图*·*

```mermaid
graph TD
    A[用户] -->|上传加密内容 文件名 文件类型| B(合约)
    B -->|进行md5加密| C{存储到map}
    C --> D[返回存储信息]
    A -->|查询文件名 时间范围| D 
    D -->|返回存储的数据| A
```

- **时序图**

```mermaid
sequenceDiagram
    participant 用户
    participant 合约

    用户->>合约: 上传加密内容、文件名、文件类型等信息
    合约->>合约: 对加密内容进行md5加密，存储到map中
    合约->>用户: 返回存储结果
    用户->>合约: 查询文件名和时间范围等信息
    合约->>用户: 返回未解密到内容、文件名、文件类型和md5值

```

## 加密过程

- 用户调用外部程序生成公私钥对。
- 外部程序返回公钥给用户。
- 用户使用外部程序返回的公钥和自己本身私钥进行ECDH数据加密。
- 外部程序解密加密信息并将结果发送回用户。
- 用户将加密后的数据上传到智能合约进行存储。
- 智能合约确认存储结果并将结果发送回用户。

```mermaid
sequenceDiagram
    participant 用户
    participant 外部程序
    participant 合约

    用户->>外部程序: 生成公私钥对
    外部程序->>用户: 返回公钥
    用户->>+外部程序: ECDH数据加密
    外部程序->>用户: 解密信息
    用户->>合约: 上传加密数据
    合约->>用户: 确认存储结果

```

## 文件共享

文件数据已经加密存储在合约中，如何将加密存储的文件进行数据共享?

### 共享文件合约操作

1. 文件拥有者向智能合约中发送可以访问文件的的用户权限、可以访问的用户和访问时间范围的设置。
2. 智能合约收到请求后进行处理，并将操作结果返回给文件拥有者。
3. 用户向外部程序发送签名数据进行查询文件数据。
4. 外部程序向智能合约进行用户身份校验和数据查询。
5. 智能合约判断将校验结果数据返回给外部程序。
6. 外部程序根据智能合约结果判断权限，如果有，则调用本地离线的数据库离线密钥进行解密并返回解密数据给用户；否则返回没有权限访问的信息。

- **时序图**

```mermaid
sequenceDiagram
    participant A as 文件拥有者
    participant B as 智能合约
    participant C as 用户
    participant D as 外部程序

    A->>B: 发送访问权限请求
    B-->>A: 返回操作结果
    C->>D: 发送签名数据查询文件数据
    D->>B: 发送用户身份校验和数据查询请求
    B-->>D: 返回校验结果
    Note over D: 判断是否有权限访问
    D->>+B: 请求解密数据
    B-->>-D: 返回加密数据
    D->>D: 解密数据
    Note over D: 判断签名是否正确
    Note over D: 判断用户权限
    alt 有权限访问
        D->>+B: 请求解密数据
        B-->>-D: 返回加密数据
        D->>D: 解密数据
        D->>C: 返回解密数据
    else 没有权限访问
        D->>C: 返回没有权限信息
    end

```

- **流程图**

```mermaid
graph TD;
    A[文件拥有者设置访问权限] -->|向智能合约发送请求| B(智能合约)
    B -->|返回操作结果| A
    C[用户查询数据] -->|发送签名数据: 共享文件MD5| D{外部程序}
    D -->|向智能合约发送请求| E(智能合约)
    E -->|返回校验结果|F{"检查用户权限"}
    F -- 有权限访问 --> G["调用离线密钥进行解密"]
    G -->|返回解密数据|H["返回数据给用户"]
    F -- 没有权限访问 --> I["返回没有权限访问的信息"]
    I -->|返回信息|C

```
